rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================
    // 1. HELPER FUNCTIONS - YOUR IMPROVED LOGIC
    // =========================================================
    
    // Check if user is Admin
    function isAdmin() {
      // Check by email (for initial setup)
      let adminByEmail = request.auth != null && 
        request.auth.token.email in [
          "gop1@gmail.com", 
          "premkumartenali@gmail.com",
          "admin@gmail.com"
        ];
      
      // Check by custom claim (more secure)
      let adminByClaim = request.auth != null && 
        request.auth.token.get('admin') == true;
      
      return adminByEmail || adminByClaim;
    }
    
    // Check if user is a Teacher
    function isTeacher() {
      let teacherByClaim = request.auth != null && 
        request.auth.token.get('teacher') == true;
      
      let teacherInCollection = request.auth != null && 
        exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
      
      return teacherByClaim || teacherInCollection;
    }
    
    // Check if user is a Parent
    function isParent() {
      let parentByClaim = request.auth != null && 
        request.auth.token.get('parent') == true;
      
      let parentInCollection = request.auth != null && 
        exists(/databases/$(database)/documents/parents/$(request.auth.uid));
      
      return parentByClaim || parentInCollection;
    }
    
    // Check if user is the owner of the data
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // =========================================================
    // 2. GLOBAL RULES
    // =========================================================
    
    // Default deny-all for unmatched documents
    match /{document=**} {
      allow read, write: if false;
    }

    // =========================================================
    // 3. CHATS & MESSAGES
    // =========================================================
    match /chats/{chatId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isTeacher();
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /chats/{chatId}/messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        isAdmin() || 
        isTeacher()
      );
      allow delete: if isAdmin() || isTeacher();
    }

    // =========================================================
    // 4. HOMEWORKS
    // =========================================================
    match /homeworks/{homeworkId} {
      // Everyone authenticated can read (teachers, admins, parents, students)
      allow read: if isAuthenticated();
      
      // Only teachers and admins can create
      allow create: if isTeacher() || isAdmin();
      
      // Only teachers and admins can update
      allow update: if isTeacher() || isAdmin();
      
      // Both teachers and admins can delete
      allow delete: if isTeacher() || isAdmin();
    }

    // =========================================================
    // 5. STUDENTS, TEACHERS, PARENTS & PROFILES
    // =========================================================
    
    // STUDENTS
    match /students/{studentId} {
      allow read: if true; 
      allow create: if isAdmin() || isTeacher();
      allow update: if isAdmin() || isTeacher();
      allow delete: if isAdmin();
    }

    match /teachers/{teacherId} {
      allow read: if isAuthenticated();

      // âœ… Allow first-time creation by the logged-in user
      allow create: if isAuthenticated() && request.auth.uid == teacherId;

      allow update: if isAuthenticated() && (
        request.auth.uid == teacherId || isAdmin()
      );

      allow delete: if isAdmin();
    }
    
    // PARENTS
    match /parents/{parentId} {
      allow read: if isAuthenticated() && (isAdmin() || isTeacher() || isOwner(parentId));
      allow create: if isAuthenticated() && isOwner(parentId);
      allow update: if isAuthenticated() && (isOwner(parentId) || isAdmin());
      allow delete: if isAdmin();
    }
    
    // USERS collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (isAdmin() || isOwner(userId));
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // =========================================================
    // 6. ATTENDANCE & REPORTS
    // =========================================================
    match /attendance/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }
    
    match /attendance_dates/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    match /teacher_reports/{document=**} {
      allow read: if isTeacher() || isAdmin();
      allow write: if isTeacher() || isAdmin();
    }

    match /photos/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // =========================================================
    // 7. MESSAGES & COMMUNICATION
    // =========================================================
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // =========================================================
    // 8. SCHEDULES & TIMETABLES
    // =========================================================
    match /schedules/{scheduleId} {
      allow read: if isAuthenticated() || isTeacher();
      allow create: if isTeacher(); // Teachers can create only (no update, no delete)
      allow read, write, delete: if isAdmin(); // Admins have full access
    }

    match /timetables/{timetable} {
      allow read: if isAuthenticated();
      allow create: if isTeacher(); // Teachers can create only (no update, no delete)
      allow read, write, delete: if isAdmin(); // Admins have full access
    }

    match /teacherProgress/{document=**} {
      allow read: if isAuthenticated() || isTeacher();
      allow create: if isTeacher(); // Teachers can create only (no update, no delete)
      allow read, write, delete: if isAdmin(); // Admins have full access
    }  
    
    // =========================================================
    // 9. NOTIFICATIONS/ANNOUNCEMENTS
    // =========================================================
    match /notifications/{notificationId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isTeacher();
      allow update: if isAdmin() || isTeacher();
      allow delete: if isAdmin();
    }

    match /chatNotifications/{notificationId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isTeacher();
      allow update: if isAdmin() || isTeacher();
      allow delete: if isAdmin() || isTeacher();
    }
    
    // =========================================================
    // 10. PARENT LOGINS
    // =========================================================
    match /parent_logins/{loginId} {
      allow read: if isAuthenticated() && (isAdmin() || isTeacher() || isParent());
      allow create: if isAuthenticated() && isParent();
      allow update: if isAuthenticated() && (isParent() || isAdmin());
      allow delete: if isAdmin();
    }

    // =========================================================
    // 11. FINANCIAL RECORDS - Updated for Teachers & Admins
    // =========================================================
    match /financial_records/{recordId} {
      // Data validation function for financial records
      function isValidFinancialRecord() {
        return 
          // Type must be OFFERING or EXPENSE
          request.resource.data.type in ['OFFERING', 'EXPENSE'] &&
          // Place must be non-empty string
          request.resource.data.place is string &&
          request.resource.data.place.size() >= 1 &&
          request.resource.data.place.size() <= 100 &&
          // Amount must be positive number
          request.resource.data.amount is number &&
          request.resource.data.amount > 0 &&
          request.resource.data.amount <= 1000000 &&
          // Timestamp validation (allow serverTimestamp)
          (request.resource.data.timestamp == request.time || 
           request.resource.data.timestamp is number);
      }
      
      function isValidForCreate() {
        return isValidFinancialRecord() &&
          // Reason is optional but if provided must be valid string
          (!('reason' in request.resource.data) || 
           (request.resource.data.reason is string &&
            request.resource.data.reason.size() <= 500)) &&
          // CreatedBy should be present
          request.resource.data.createdBy is string &&
          request.resource.data.createdBy.size() >= 1 &&
          // CreatedByUid should match the authenticated user
          request.resource.data.createdByUid == request.auth.uid;
      }
      
      function isValidForUpdate() {
        return isValidFinancialRecord() &&
          // Preserve original type (cannot change offering to expense or vice versa)
          request.resource.data.type == resource.data.type &&
          // Preserve original place
          request.resource.data.place == resource.data.place &&
          // Preserve original createdBy and createdByUid
          request.resource.data.createdBy == resource.data.createdBy &&
          request.resource.data.createdByUid == resource.data.createdByUid;
      }
      
      // READ - Admins and Teachers can view all financial records
      allow read: if isAdmin() || isTeacher();
      
      // CREATE - Admins and Teachers can create records
      allow create: if (isAdmin() || isTeacher()) && 
        isValidForCreate();
      
      // UPDATE - Only Admins can modify (for audit integrity)
      allow update: if isAdmin() && 
        isValidForUpdate();
      
      // DELETE - Only Admins can delete (for audit integrity)
      allow delete: if isAdmin();
    }

    // =========================================================
    // 12. USER TOKENS (for notifications)
    // =========================================================
    match /userTokens/{tokenId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId) || isAdmin();
    }
  }
}
